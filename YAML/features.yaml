schema_version: 1
generated_on: 2026-02-25

project:
  name: AlpInn
  repository_root: .
  type: web_application
  stack:
    backend:
      - PHP 8+
      - PDO MySQL
    frontend:
      - HTML/CSS/JS
      - Swiper
      - Isotope
    infra:
      - cron (project reminders)
      - SMTP (custom implementation)

maintenance:
  source_of_truth: features.yaml
  update_policy:
    - Update this file when a route, admin page, endpoint, or user-visible workflow changes.
    - Keep one feature per user-visible capability (not per helper function).
    - Keep dependencies explicit in `relationships`.
  status_values:
    - implemented
    - partial
    - placeholder

feature_definition:
  include_as_feature:
    - User-visible capability (public, client, admin, API consumer).
    - Operational capability that changes behavior (cron, moderation, anti-abuse).
  exclude_as_feature:
    - Internal helper-only functions.
    - Pure styling-only changes with no behavior impact.

actors:
  - id: guest
    label: Visiteur non connecte
  - id: user
    label: Utilisateur connecte
  - id: group_chief
    label: Chef de groupe admin
  - id: admin
    label: Admin par page/groupe
  - id: superadmin
    label: Niveau 100
  - id: api_consumer
    label: Client externe API
  - id: cron_runner
    label: Processus cron (CLI ou HTTP avec token)

domains:
  - id: public_web
    label: Site public
    level: 1
    status: implemented
    evidence:
      - public/index.php
      - public/client-news.php
      - public/client-events.php
      - public/association-report.php
    features:
      - id: public_dynamic_homepage
        label: Homepage dynamique (contenu base de donnees)
        level: 2
        type: mandatory
        status: implemented
        actors: [guest, user]
        routes:
          - /public/index.php
        data_entities:
          - staff_members
          - activities
          - testimonials
          - faq_items
          - news_items
          - association_members
          - association_statuses
          - association_values
          - association_volunteers
          - association_partners
          - association_reports
      - id: public_news_rail
        label: Rail de news approuvees + liens externes
        level: 2
        status: implemented
        routes:
          - /public/index.php
          - /public/client-news.php
        data_entities:
          - news_items
          - audit_reviews
      - id: public_alert_banner
        label: Bandeau alerte configurable
        level: 2
        status: implemented
        routes:
          - /public/index.php
        data_entities:
          - settings
      - id: public_alert_popups
        label: Popups alertes multiples
        level: 2
        status: implemented
        routes:
          - /public/index.php
        data_entities:
          - alert_messages
      - id: public_site_event_popups
        label: Popups evenement site avec statut live/upcoming
        level: 2
        status: implemented
        routes:
          - /public/index.php
          - /public/client-events.php
        data_entities:
          - site_events
      - id: public_contact_form
        label: Formulaire contact avec stockage
        level: 2
        status: implemented
        routes:
          - /public/index.php#contact
        data_entities:
          - contact_messages
      - id: public_activities_showcase
        label: Galerie activites avec filtres categorie + lightbox
        level: 2
        status: implemented
        routes:
          - /public/index.php#portfolio
      - id: public_association_report_download
        label: Export PDF association
        level: 2
        status: implemented
        routes:
          - /public/association-report.php
        data_entities:
          - association_members
          - association_statuses
          - association_values
          - association_volunteers
          - association_partners
          - association_reports
      - id: public_guest_agenda_modal
        label: Modal agenda pour visiteur (iframe embed)
        level: 2
        status: implemented
        routes:
          - /public/index.php
          - /public/client-events.php?embed=1

  - id: auth_identity
    label: Authentification et identite
    level: 1
    status: implemented
    evidence:
      - public/login.php
      - public/logout.php
      - public/register.php
      - public/activate.php
      - app/auth.php
    features:
      - id: auth_login
        label: Connexion email ou username
        level: 2
        status: implemented
        routes:
          - /public/login.php
        data_entities:
          - users
      - id: auth_logout
        label: Deconnexion
        level: 2
        status: implemented
        routes:
          - /public/logout.php
      - id: auth_register
        label: Inscription avec validation et anti-bot
        level: 2
        status: implemented
        routes:
          - /public/register.php
        data_entities:
          - users
          - user_activation_tokens
      - id: auth_email_activation
        label: Activation compte par token 24h
        level: 2
        status: implemented
        routes:
          - /public/activate.php
      - id: auth_lockout_policy
        label: Verrouillage temporaire apres echecs login
        level: 2
        status: implemented
        data_entities:
          - users
      - id: auth_group_based_access
        label: Controle acces par groupe, niveau, hierarchie
        level: 2
        status: implemented
        data_entities:
          - groups
          - group_children
          - users
      - id: auth_activation_email_delivery
        label: Envoi mail activation via SMTP actif
        level: 2
        status: implemented
        data_entities:
          - smtp_settings

  - id: client_space
    label: Espace client
    level: 1
    status: partial
    evidence:
      - public/client.php
      - public/client-news.php
      - public/client-events.php
    features:
      - id: client_home
        label: Landing espace client
        level: 2
        status: partial
        routes:
          - /public/client.php
      - id: client_news_listing
        label: Consultation news approuvees
        level: 2
        status: implemented
        routes:
          - /public/client-news.php
      - id: client_events_calendar
        label: Agenda mensuel evenement (desktop + mobile)
        level: 2
        status: implemented
        routes:
          - /public/client-events.php
        data_entities:
          - site_events
      - id: client_events_visibility_toggle
        label: Toggle visibilite evenements (localStorage)
        level: 2
        status: implemented
        routes:
          - /public/client-events.php
      - id: client_message_widget
        label: Widget messagerie integre
        level: 2
        status: implemented
        routes:
          - /public/client.php
          - /public/client-news.php
          - /public/client-events.php

  - id: messaging_social
    label: Messagerie et social
    level: 1
    status: implemented
    evidence:
      - public/messages.php
      - app/messaging.php
      - admin/reports.php
    features:
      - id: messaging_consent_gate
        label: Consentement obligatoire avant usage messagerie
        level: 2
        status: implemented
        data_entities:
          - message_consents
      - id: messaging_friend_requests
        label: Demandes d amis (envoyer/accepter/refuser/annuler)
        level: 2
        status: implemented
        data_entities:
          - user_friendships
      - id: messaging_direct_threads
        label: Conversations directes utilisateur-utilisateur
        level: 2
        status: implemented
        data_entities:
          - user_messages
      - id: messaging_send_rules
        label: Restriction envoi (ami accepte ou niveau admin)
        level: 2
        status: implemented
      - id: messaging_read_receipts
        label: Statut lu/envoye + marquage read
        level: 2
        status: implemented
        data_entities:
          - user_messages
          - chat_members
      - id: messaging_conversation_hiding
        label: Masquer conversation
        level: 2
        status: implemented
        data_entities:
          - message_conversation_hides
      - id: messaging_delete_report_unreport
        label: Supprimer message perso + signaler/retirer signalement
        level: 2
        status: implemented
        data_entities:
          - message_reports
      - id: messaging_blocks_and_mute
        label: Bloquer ou masquer un utilisateur
        level: 2
        status: implemented
        data_entities:
          - user_blocks
      - id: messaging_user_presence_prefs
        label: Preferences visibilite + silent mode + notif badge/mail
        level: 2
        status: implemented
        data_entities:
          - users
          - settings
      - id: messaging_group_chats
        label: Groupes chat (creation, invitation, quitter, envoi)
        level: 2
        status: implemented
        data_entities:
          - chat_rooms
          - chat_members
          - chat_messages
      - id: messaging_realtime_polling
        label: Polling et endpoints AJAX (state/thread/conversations/mark_read)
        level: 2
        status: implemented
        routes:
          - /public/messages.php?api=1
      - id: messaging_widget_payload
        label: Resume messages + demandes amies pour widget global
        level: 2
        status: implemented
      - id: messaging_moderation_suspensions
        label: Blocage temporaire messagerie utilisateur sanctionne
        level: 2
        status: implemented
        data_entities:
          - message_suspensions
          - message_moderation_logs

  - id: admin_console
    label: Console admin
    level: 1
    status: implemented
    evidence:
      - admin/_nav.php
      - app/auth.php
    features:
      - id: admin_dashboard
        label: Dashboard metriques
        level: 2
        status: implemented
        routes:
          - /admin/index.php
      - id: admin_users
        label: Gestion utilisateurs
        level: 2
        status: implemented
        routes:
          - /admin/users.php
        capabilities:
          - creer utilisateur
          - changer groupe
          - activer/desactiver compte
          - renvoyer email activation
          - supprimer compte (avec transfert ownership projets)
          - definir chef de groupe
      - id: admin_groups
        label: Gestion groupes et hierarchie parent/enfant
        level: 2
        status: implemented
        routes:
          - /admin/groups.php
        capabilities:
          - creer/modifier/supprimer groupe
          - definir sous-groupes
          - detection boucles hierarchie
          - contraintes de niveau
      - id: admin_calendar_projects
        label: Agenda partage et gestion projets
        level: 2
        status: implemented
        routes:
          - /admin/calendar.php
        capabilities:
          - CRUD projet (status, couleur, dates, notify)
          - membres projet (add/update/remove roles)
          - acces par groupes (viewer/editor)
          - transfert proprietaire
          - evenements projet + taches
          - rappels projet
          - historique projet
          - visualisation calendrier multi-projets
      - id: admin_site_events
        label: Planification evenements site (popups homepage)
        level: 2
        status: implemented
        routes:
          - /admin/events.php
      - id: admin_activities
        label: Gestion activites vitrines
        level: 2
        status: implemented
        routes:
          - /admin/activities.php
      - id: admin_staff
        label: Gestion staff public
        level: 2
        status: implemented
        routes:
          - /admin/staff.php
      - id: admin_association
        label: Gestion contenus association
        level: 2
        status: implemented
        routes:
          - /admin/association.php
        capabilities:
          - valeurs
          - textes benevoles
          - partenaires + logos
          - rapports PDF + nettoyage fichiers
          - membres + avatars
          - statuts
      - id: admin_content
        label: Reglages rapides site et alertes
        level: 2
        status: implemented
        routes:
          - /admin/content.php
        capabilities:
          - site_title / hero / discord / notice contact
          - bandeau alerte
          - popups alertes multiples
      - id: admin_news
        label: Gestion news publiques
        level: 2
        status: implemented
        routes:
          - /admin/news.php
        capabilities:
          - create/update/toggle/delete
          - upload image news
          - nettoyage images non referencees
      - id: admin_smtp
        label: Gestion configurations SMTP
        level: 2
        status: implemented
        routes:
          - /admin/smtp.php
      - id: admin_api
        label: Gestion API publique
        level: 2
        status: implemented
        routes:
          - /admin/api.php
        capabilities:
          - creation/revocation/reactivation cles API
          - parametrage anti-abuse et CORS
          - blacklist IP manuelle
          - logs API + purge
          - catalogue endpoints
          - export OpenAPI JSON
      - id: admin_messages_monitoring
        label: Monitoring conversations utilisateurs
        level: 2
        status: implemented
        routes:
          - /admin/messages.php
      - id: admin_reports_moderation
        label: Signalements + moderation messagerie
        level: 2
        status: implemented
        routes:
          - /admin/reports.php
        capabilities:
          - traiter signalement
          - avertir utilisateur
          - bloquer messagerie (mute temporaire)
          - notifier reporter + cible
          - contexte conversation autour message
          - historique actions moderation
      - id: admin_audit
        label: Journal audit avec filtres par categorie et niveau
        level: 2
        status: implemented
        routes:
          - /admin/audit.php
      - id: admin_approvals
        label: Validations des actions admin (chefs/superadmin)
        level: 2
        status: implemented
        routes:
          - /admin/approvals.php
        capabilities:
          - approuver/refuser
          - filtrer par statut/groupe
          - suppression automatique d un create refuse (entites supportees)
      - id: admin_db_check
        label: Verification connexion base de donnees
        level: 2
        status: implemented
        routes:
          - /admin/db.php
      - id: admin_settings_placeholder
        label: Page settings (en construction)
        level: 2
        status: placeholder
        routes:
          - /admin/settings.php
      - id: admin_user_edit_placeholder
        label: Page user_edit (en construction)
        level: 2
        status: placeholder
        routes:
          - /admin/user_edit.php

  - id: public_api
    label: API publique versionnee
    level: 1
    status: implemented
    evidence:
      - app/api.php
      - public/api/v1/news.php
      - public/api/v1/events.php
      - public/api/v1/staff.php
      - public/api/v1/activities.php
      - public/api/v1/statuts.php
      - public/api/v1/association.php
    features:
      - id: api_authentication
        label: Auth API key (header X-API-Key)
        level: 2
        status: implemented
      - id: api_antiflood_ratelimit
        label: Cooldown, rate limit, flood detection, blacklist auto
        level: 2
        status: implemented
        data_entities:
          - api_ip_state
          - api_ip_blacklist
          - api_key_request_state
      - id: api_request_logging
        label: Logging detaille des requetes API
        level: 2
        status: implemented
        data_entities:
          - api_request_logs
      - id: api_catalog_endpoints
        label: Endpoints contenus publics (news/events/staff/activities/statuts/association)
        level: 2
        status: implemented
      - id: api_filters_pagination_cache
        label: Filtres, pagination, cache headers ETag/Last-Modified
        level: 2
        status: implemented
      - id: api_openapi_generation
        label: Generation spec OpenAPI 3.0.3
        level: 2
        status: implemented

  - id: automation_jobs
    label: Automatisation et cron
    level: 1
    status: implemented
    evidence:
      - public/cron/project_reminders.php
    features:
      - id: cron_project_reminders
        label: Envoi automatique rappels projet (site + email)
        level: 2
        status: implemented
        routes:
          - /public/cron/project_reminders.php
        data_entities:
          - project_reminders
          - project_members
          - project_reminder_sends
          - project_cron_logs
      - id: cron_http_token_guard
        label: Protection HTTP par CRON_TOKEN (CLI bypass)
        level: 2
        status: implemented
      - id: cron_dedup_send_records
        label: Anti-doublon envoi par date/canal/utilisateur
        level: 2
        status: implemented

  - id: security_and_governance
    label: Securite et gouvernance
    level: 1
    status: implemented
    evidence:
      - app/csrf.php
      - app/helpers.php
      - app/audit.php
      - app/auth.php
      - public/serve.php
    features:
      - id: security_csrf
        label: Protection CSRF sur formulaires
        level: 2
        status: implemented
      - id: security_secure_file_serving
        label: Serveur fichiers uploads securise (whitelist + anti traversal)
        level: 2
        status: implemented
      - id: security_upload_validation
        label: Validation MIME/taille upload + conversion webp selective
        level: 2
        status: implemented
      - id: security_rich_text_sanitization
        label: Sanitization HTML riche limitee
        level: 2
        status: implemented
      - id: governance_audit_log
        label: Journal audit centralise des actions
        level: 2
        status: implemented
      - id: governance_audit_review
        label: Workflow approbation/rejet actions admin
        level: 2
        status: implemented
      - id: governance_auto_review_for_validators
        label: Auto-validation actions des validateurs autorises
        level: 2
        status: implemented
      - id: governance_page_level_access_model
        label: Mapping acces page admin par groupe/niveau
        level: 2
        status: implemented

  - id: ops_install
    label: Installation et exploitation
    level: 1
    status: implemented
    evidence:
      - sql/schema.sql
      - sql/init_DB.php
      - sql/create_admin.php
      - README.md
      - app/config.php
      - Dockerfile
    features:
      - id: ops_schema_bootstrap
        label: Schema SQL complet avec donnees de base
        level: 2
        status: implemented
      - id: ops_init_db_script
        label: Script reset/recreate DB + superadmin
        level: 2
        status: implemented
      - id: ops_create_admin_script
        label: Script creation superadmin si absent
        level: 2
        status: implemented
      - id: ops_env_configuration
        label: Configuration .env (DB, APP_URL, SESSION, CSRF, uploads, cron token)
        level: 2
        status: implemented
      - id: ops_root_redirect_public
        label: Redirection racine vers /public
        level: 2
        status: implemented

  - id: future_backlog
    label: Chantiers identifies dans le code
    level: 1
    status: partial
    evidence:
      - IDee.md
      - admin/settings.php
      - admin/user_edit.php
      - public/client.php
    features:
      - id: backlog_client_profile_extension
        label: Enrichir espace client (profil, etc.)
        level: 2
        status: partial
      - id: backlog_notification_improvements
        label: Ameliorer notifications activites/evenements
        level: 2
        status: partial
      - id: backlog_calendar_task_event_bugfix
        label: Corriger conflit formulaire tache/evenement
        level: 2
        status: partial
      - id: backlog_hour_precision
        label: Precision horaire dans creation taches/evenements
        level: 2
        status: partial

relationships:
  - from: public_news_rail
    to: admin_news
    type: managed_by
  - from: public_site_event_popups
    to: admin_site_events
    type: managed_by
  - from: public_alert_banner
    to: admin_content
    type: managed_by
  - from: public_alert_popups
    to: admin_content
    type: managed_by
  - from: public_dynamic_homepage
    to: admin_staff
    type: consumes_data_from
  - from: public_dynamic_homepage
    to: admin_activities
    type: consumes_data_from
  - from: public_dynamic_homepage
    to: admin_association
    type: consumes_data_from
  - from: auth_register
    to: admin_smtp
    type: depends_on_for_email
  - from: client_events_calendar
    to: admin_site_events
    type: depends_on_data
  - from: messaging_direct_threads
    to: auth_login
    type: requires
  - from: admin_reports_moderation
    to: messaging_delete_report_unreport
    type: processes
  - from: admin_approvals
    to: governance_audit_log
    type: requires
  - from: admin_approvals
    to: governance_audit_review
    type: writes
  - from: api_catalog_endpoints
    to: admin_api
    type: documented_in
  - from: cron_project_reminders
    to: admin_calendar_projects
    type: executes_for
  - from: cron_project_reminders
    to: admin_smtp
    type: depends_on_for_email
  - from: client_message_widget
    to: messaging_widget_payload
    type: depends_on
  - from: public_guest_agenda_modal
    to: client_events_calendar
    type: embeds

tables_index:
  auth_and_users:
    - users
    - groups
    - group_children
    - user_activation_tokens
  content_public:
    - staff_members
    - activities
    - testimonials
    - faq_items
    - news_items
    - site_events
    - alert_messages
    - contact_messages
    - association_members
    - association_statuses
    - association_values
    - association_volunteers
    - association_partners
    - association_reports
  projects:
    - projects
    - project_members
    - project_group_access
    - project_events
    - project_reminders
    - project_history
    - project_reminder_sends
    - project_cron_logs
  messaging:
    - user_friendships
    - user_messages
    - message_consents
    - message_conversation_hides
    - user_blocks
    - message_reports
    - message_suspensions
    - message_moderation_logs
    - chat_rooms
    - chat_members
    - chat_messages
  api:
    - api_keys
    - api_settings
    - api_ip_state
    - api_ip_blacklist
    - api_key_request_state
    - api_request_logs
  governance:
    - audit_log
    - audit_reviews
    - settings
